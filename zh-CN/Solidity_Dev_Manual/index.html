<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>入门手册 · PlatON</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## 入门手册"/><meta name="docsearch:language" content="zh-CN"/><meta property="og:title" content="入门手册 · PlatON"/><meta property="og:type" content="website"/><meta property="og:url" content="https://luo-dahui.github.io//docs/"/><meta property="og:description" content="## 入门手册"/><meta property="og:image" content="https://luo-dahui.github.io//docs/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://luo-dahui.github.io//docs/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/docs/img/logo.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid@8.4.0/dist/mermaid.min.js"></script><script type="text/javascript" src="/docs/js/custom.js"></script><script src="/docs/js/scrollSpy.js"></script><link rel="stylesheet" href="/docs/css/main.css"/><script src="/docs/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="https://www.platon.network/?lang=zh"><img class="logo" src="/docs/img/PlatON-logo.svg" alt="PlatON"/></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/docs/img/language.svg" alt="Languages icon"/>中文</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/en/Solidity_Dev_Manual">English</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Solidity合约</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">概述<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/">概述</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">初步了解<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/lat_introduced">什么是LAT</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/staking_and_delegation">质押&amp;委托</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Network_Description">网络说明</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">进阶了解<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/PlatON_Overall_Solution">总体架构</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Economic_Model">经济模型</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/PlatON_Solution">共识机制</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/PlatON_Governance_Solution">治理机制</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Wasm_Operation_Principle">Wasm虚拟机</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">PlatON节点<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/PlatON_Validation_Introduce">验证节点介绍</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Become_PlatON_Main_Verification">成为主网验证节点</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">节点工具</h4><ul><li class="navListItem"><a class="navItem" href="/docs/zh-CN/OnLine_MTool_Manual">MTool在线教程</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/OffLine_MTool_Manual">MTool离线教程</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Command_Line_Tools">命令行工具</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">开发者<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/PlatON_Overview_DevGuide">开发指南</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">设置开发环境</h4><ul><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Join_Dev_Network">接入开发网</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Build_Private_Chain">部署私有网络</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">智能合约</h4><ul><li class="navListItem"><a class="navItem" href="/docs/zh-CN/PlatON_system_contract">系统合约</a></li></ul></div><div class="navGroup subNavGroup sonNavGroup"><h4 class="navGroupSubcategoryTitle sonNavTitle">Solidity合约</h4><ul><li class="navListItem navListItemActive"><a class="navItem" href="/docs/zh-CN/Solidity_Dev_Manual">入门手册</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Solidity_Contract_Migrate">合约迁移教程</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Solidity_Contract_Dev_Costs">合约开发成本</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Solidity_Contract_Best_Practice">合约开发最佳实践</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Solidity_Contract_Security_Dev_Guide">合约安全开发指南</a></li></ul></div><div class="navGroup subNavGroup sonNavGroup"><h4 class="navGroupSubcategoryTitle sonNavTitle">Wasm合约</h4><ul><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Wasm_Dev_Manual">入门手册</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Wasm_Contract_Dev_Costs">合约开发成本</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Wasm_Contract_Best_Practice">合约开发最佳实践</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Wasm_Contract_API">合约API</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">API参考</h4><ul><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Python_SDK">Python SDK</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/JS_SDK">JS SDK</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Java_SDK">Java SDK</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Json_Rpc">JSON-RPC</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Samurai_API">Samurai API</a></li></ul></div><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Standards">Standards</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">数据分析<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/PlatON_BlockChain_Browser">PlatScan</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/PlatEye">PlatEye</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">钱包<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/ATON-user-manual">ATON钱包</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Samurai_user_manual">Samurai</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/Third_Party_Walle">第三方钱包</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">community<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/community">社区项目</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">入门手册</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="入门手册"></a><a href="#入门手册" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入门手册</h2>
<h3><a class="anchor" aria-hidden="true" id="简介"></a><a href="#简介" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简介</h3>
<p>本教程主要是指导用户在PlatON上使用solidity语言创建简单的HelloWorld智能合约，通过platon-truffle编译，部署，调用此合约。如果您想使用更加丰富的API可以参考<a href="/docs/zh-CN/Java_SDK">Java SDK开发指南</a> 或者 <a href="/docs/zh-CN/JS_SDK">JS SDK开发指南</a></p>
<ul>
<li>solidity智能合约语法请参考<a href="https://solidity.readthedocs.io/en/develop/">Solidity官方文档</a></li>
<li>在开发合约前，如果需要搭建节点连接到PlatON网络或者创建私有网络请参考：<a href="/docs/zh-CN/Join_PlatON_NetWork">连接 PlatON 网络</a></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="platon-truffle开发工具介绍"></a><a href="#platon-truffle开发工具介绍" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>platon-truffle开发工具介绍</h3>
<p>platon-truffle是PlatON提供的一款能够在本地编译、部署、调用智能合约的工具，具体的安装及使用手册参见</p>
<ul>
<li>platon-truffle开发工具<a href="https://platon-truffle.readthedocs.io/en/v0.13.1/getting-started/installation.html">安装参考</a></li>
<li>platon-truffle开发工具<a href="https://platon-truffle.readthedocs.io/en/v0.13.1/">使用手册</a></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="创建helloworld合约"></a><a href="#创建helloworld合约" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建HelloWorld合约</h3>
<pre><code class="hljs css language-solidity">pragma solidity ^<span class="hljs-number">0.5</span><span class="hljs-number">.13</span>;

contract HelloWorld {
    
    string <span class="hljs-type">name</span>;
    
    <span class="hljs-keyword">function</span> setName(string memory _name) <span class="hljs-built_in">public</span> <span class="hljs-keyword">returns</span>(string memory){
        <span class="hljs-type">name</span> = _name;
        <span class="hljs-keyword">return</span> <span class="hljs-type">name</span>;
    }
    
    <span class="hljs-keyword">function</span> getName() <span class="hljs-built_in">public</span> <span class="hljs-keyword">view</span> <span class="hljs-keyword">returns</span>(string memory){
        <span class="hljs-keyword">return</span> <span class="hljs-type">name</span>;
    }
}
</code></pre>
<p>合约文件说明</p>
<ul>
<li>pragma solidity ^0.5.13
<ul>
<li>pragma solidity：是solidity版本声明
0.5.13：代表solidity版本
^ ：表示向上兼容,即可以用0.5.13以上版本编译器进行编译</li>
</ul></li>
<li>contract HelloWorld
<ul>
<li>contract：合约声明的关键字
HelloWorld：当前合约的名称</li>
</ul></li>
<li>string name
<ul>
<li>name：合约的状态变量
string：指明此状态变量的类型</li>
</ul></li>
<li>function setName(string memory _name) public returns(string memory)
<ul>
<li>function：合约中函数声明关键字
setName：此函数的名称
memory：声明_name参数的存储位置（字符串类型的函数输入参数与输出参数必须声明为memory）
_name：为此函数的局部变量
public：声明此函数的可见性
name = _name：此操作将外部传进来的局部变量赋值给状态变量</li>
</ul></li>
<li>function getName() public view returns(string memory)
<ul>
<li>view:如果一个函数带有view关键字，此函数将不会改变合约中状态变量的值（主要用于查询）</li>
</ul></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="编译helloworld合约"></a><a href="#编译helloworld合约" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译HelloWorld合约</h3>
<p><strong>step1.</strong> 为HelloWorld项目创建新目录</p>
<pre><code class="hljs"><span class="hljs-built_in">mkdir</span> HelloWorld &amp;&amp; <span class="hljs-built_in">cd</span> HelloWorld
</code></pre>
<ul>
<li>以下命令如果没有特殊说明都在HelloWorld目录下进行</li>
</ul>
<p><strong>step2.</strong> 使用platon-truffle初始化一个工程</p>
<pre><code class="hljs"><span class="hljs-attribute">platon-truffle init</span>
</code></pre>
<p>在操作完成之后，就有如下项目结构：</p>
<ul>
<li><p>contracts/: Solidity合约目录</p></li>
<li><p>migrations/: 部署脚本文件目录</p></li>
<li><p>test/: 测试脚本目录</p></li>
<li><p>truffle-config.js: platon-truffle 配置文件</p></li>
</ul>
<p><strong>step3.</strong> 将之前编写好的HelloWorld合约放至HelloWorld/contracts/目录下</p>
<pre><code class="hljs"><span class="hljs-keyword">ls</span> contracts/
</code></pre>
<ul>
<li>将看到HelloWorld.sol</li>
</ul>
<p><strong>step4.</strong> 修改platon-truffle 配置文件truffle-config.js，将编译器版本修改对应的solidity合约中的版本号</p>
<pre><code class="hljs">vim truffle-<span class="hljs-built_in">config</span>.<span class="hljs-keyword">js
</span></code></pre>
<p>truffle-config.js 修改部分内容如下：</p>
<pre><code class="hljs"><span class="hljs-selector-tag">compilers</span>: {
      <span class="hljs-attribute">solc</span>: {
            version: <span class="hljs-string">"^0.5.13"</span>,    // 此版本号与HelloWorld.sol中声明的版本号保持一致
      }
}
</code></pre>
<p><strong>step5.</strong> 编译合约</p>
<pre><code class="hljs"><span class="hljs-attribute">platon-truffle compile</span>
</code></pre>
<p>在操作完成之后，生成如下目录结构：</p>
<ul>
<li><p>build/: Solidity合约编译后的目录</p></li>
<li><p>build/contracts/HelloWorld.json  HelloWorld.sol对应的编译文件</p></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="部署helloworld合约"></a><a href="#部署helloworld合约" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署HelloWorld合约</h3>
<p><strong>step1.</strong> 新增合约部署脚本文件</p>
<pre><code class="hljs">cd migrations/ &amp;&amp; <span class="hljs-section">touch</span> <span class="hljs-number">2</span>_initial_helloworld.js
</code></pre>
<p>部署脚本文件名建议使用合约名称便于后面维护,如HelloWorld合约对应的部署脚本文件为2_initial_helloworld.js，内容如下所示：</p>
<pre><code class="hljs"><span class="hljs-keyword">const</span> helloWorld = artifacts.require(<span class="hljs-string">"HelloWorld"</span>); <span class="hljs-comment">//artifacts.require告诉platon-truffle需要部署哪个合约，HelloWorld即之前写的合约类名</span>
    <span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">deployer</span>) </span>{
       deployer.deploy(helloWorld); <span class="hljs-comment">//helloWorld即之前定义的合约抽象（部署带参数的合约失败，请参考FAQ部署带参数合约失败说明）</span>
};
</code></pre>
<p><strong>step2.</strong> 修改truffle-config.js中链的配置信息</p>
<pre><code class="hljs">vim truffle-<span class="hljs-built_in">config</span>.<span class="hljs-keyword">js
</span></code></pre>
<p>将truffle-config.js中的区块链相关配置修改成您真实连接的链配置</p>
<pre><code class="hljs"><span class="hljs-symbol">networks:</span> {
<span class="hljs-symbol">    development:</span> {
<span class="hljs-symbol">       host:</span> <span class="hljs-string">"10.1.1.6"</span>,     <span class="hljs-comment">// 区块链所在服务器主机</span>
<span class="hljs-symbol">       port:</span> <span class="hljs-number">8806</span>,            <span class="hljs-comment">// 链端口号</span>
<span class="hljs-symbol">       network_id:</span> <span class="hljs-string">"*"</span>,       <span class="hljs-comment">// Any network (default: none)</span>
<span class="hljs-symbol">       from:</span> <span class="hljs-string">"lax1uqug0zq7rcxddndleq4ux2ft3tv6dqljphydrl"</span>, <span class="hljs-comment">//部署合约账号的钱包地址</span>
<span class="hljs-symbol">       gas:</span> <span class="hljs-number">999999</span>,
<span class="hljs-symbol">       gasPrice:</span> <span class="hljs-number">50000000004</span>,
    },
}
</code></pre>
<p><strong>step3.</strong>  解锁钱包账户</p>
<p>进入platon-truffle控制台</p>
<pre><code class="hljs">platon-truffle<span class="hljs-built_in"> console
</span></code></pre>
<p>导入私钥（如果之前已导入可以跳过此步骤）</p>
<pre><code class="hljs"><span class="hljs-selector-tag">web3</span><span class="hljs-selector-class">.platon</span><span class="hljs-selector-class">.personal</span><span class="hljs-selector-class">.importRawKey</span>("您的钱包私钥","您的钱包密码");
</code></pre>
<p>导入成功将看到私钥对应的地址：</p>
<pre><code class="hljs"><span class="hljs-symbol">'lax1uqug0zq7rcxddndleq4ux2ft3tv6dqljphydrl</span>'
</code></pre>
<p>解锁钱包账户</p>
<pre><code class="hljs"> <span class="hljs-selector-tag">web3</span><span class="hljs-selector-class">.platon</span><span class="hljs-selector-class">.personal</span><span class="hljs-selector-class">.unlockAccount</span>(<span class="hljs-string">'您的钱包地址'</span>,<span class="hljs-string">'您的钱包密码'</span>,<span class="hljs-number">999999</span>);
</code></pre>
<p>解锁成功将看到如下信息：</p>
<pre><code class="hljs"><span class="hljs-attribute">ture</span>
</code></pre>
<p><strong>step4.</strong>  部署合约</p>
<pre><code class="hljs"><span class="hljs-attribute">platon-truffle migrate</span>
</code></pre>
<p>部署成功后，将看到类似如下信息：</p>
<pre><code class="hljs"><span class="hljs-string">2_initial_helloworld.js</span>
<span class="hljs-string">======================</span>

   <span class="hljs-string">Deploying</span> <span class="hljs-string">'HelloWorld'</span>
   <span class="hljs-string">----------------------</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">transaction hash:</span>    <span class="hljs-number">0x87cd48cc467f9bc943fd096c57c8a7e7b7fa941380538d9e59797800c6c4292c</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">Blocks: 0            Seconds:</span> <span class="hljs-number">0</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">contract address:</span>    <span class="hljs-string">lax1h95ywjy3jwt047ph697cuuqqn4d6jyrah7fw07</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">block number:</span>        <span class="hljs-number">282520</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">block timestamp:</span>     <span class="hljs-number">1585535169200</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">account:</span>             <span class="hljs-string">lax1uqug0zq7rcxddndleq4ux2ft3tv6dqljphydrl</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">balance:</span>             <span class="hljs-number">16447231233352977496646259638377769924557918764752765436645.336513079692286014</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">gas used:</span>            <span class="hljs-number">145569</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">gas price:</span>           <span class="hljs-number">1</span> <span class="hljs-string">gvon</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">value sent:</span>          <span class="hljs-number">0</span> <span class="hljs-string">LAT</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">total cost:</span>          <span class="hljs-number">0.000145569</span> <span class="hljs-string">LAT</span>


   <span class="hljs-string">&gt;</span> <span class="hljs-string">Saving</span> <span class="hljs-string">migration</span> <span class="hljs-string">to</span> <span class="hljs-string">chain.</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-string">Saving</span> <span class="hljs-string">artifacts</span>
   <span class="hljs-string">-------------------------------------</span>
   <span class="hljs-string">&gt;</span> <span class="hljs-attr">Total cost:</span>          <span class="hljs-number">0.000145569</span> <span class="hljs-string">LAT</span>

<span class="hljs-string">Summary</span>
<span class="hljs-string">=======</span>
<span class="hljs-string">&gt;</span> <span class="hljs-attr">Total deployments:</span>   <span class="hljs-number">2</span>
<span class="hljs-string">&gt;</span> <span class="hljs-attr">Final cost:</span>          <span class="hljs-number">0.000259892</span> <span class="hljs-string">LAT</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="调用helloworld合约"></a><a href="#调用helloworld合约" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用HelloWorld合约</h3>
<p><strong>step1.</strong>  进入platon-truffle控制台</p>
<pre><code class="hljs">platon-truffle<span class="hljs-built_in"> console
</span></code></pre>
<ul>
<li>以下调用查询将在truffle控制台中进行</li>
</ul>
<p><strong>step2.</strong>  构建合约对象</p>
<pre><code class="hljs css language-json">var abi = [{"constant":false,"inputs":[{"internalType":"string","name":"_name","type":"string"}],"name":"setName","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getName","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"}]; //可以从HelloWorld/build/contracts/HelloWorld.json文件中获取到

var contractAddr = 'lax1h95ywjy3jwt047ph697cuuqqn4d6jyrah7fw07';//部署合约时的获取的地址
var helloWorld = new web3.platon.Contract(abi,contractAddr); 
</code></pre>
<p>说明：</p>
<ul>
<li><code>abi</code> 是合约提供给外部调用时的接口，每个合约对应的abi在编译后的文件中，如：<code>HelloWorld/build/contracts/HelloWorld.json</code> 中可以找到</li>
<li><code>contractAddr</code> 在部署合约成功后有一个contract address</li>
<li><code>helloWorld</code> 就是构建出来与链上合约交互的合约对象抽象</li>
</ul>
<p><strong>step3.</strong>  调用合约</p>
<pre><code class="hljs css language-javascript">helloWorld.methods.setName(<span class="hljs-string">"hello world"</span>).send({<span class="hljs-attr">from</span>: <span class="hljs-string">'lax1uqug0zq7rcxddndleq4ux2ft3tv6dqljphydrl'</span>}).on(<span class="hljs-string">'receipt'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">receipt</span>) </span>{<span class="hljs-built_in">console</span>.log(receipt);}).on(<span class="hljs-string">'error'</span>, <span class="hljs-built_in">console</span>.error);
 
</code></pre>
<p>调用合约命令说明：</p>
<ul>
<li><code>helloWorld</code> 是之前构建的合约对象</li>
<li><code>methods</code> 固定语法,指量后面紧跟合约的方法名</li>
<li><code>setName</code> 是我们HelloWorld合约中的一个方法，有一个String类型的入参，此处入参为<code>hello world</code></li>
<li><code>from</code> 调用者的钱包地址</li>
<li><code>on</code> 是监听合约处理结果事件，此处如果成功将打印回执，失败输出错误日志</li>
</ul>
<p>函数调用成功，将会看到如下信息：</p>
<pre><code class="hljs">{ blockHash:
  '0xe592a4f203ed058df<span class="hljs-number">7515205717</span>f<span class="hljs-number">167848</span>b1a56b8bb143f9eba512facae22aa1',
  blockNumber: <span class="hljs-number">283911</span>,
  contractAddress: <span class="hljs-literal">null</span>,
  cumulativeGasUsed: <span class="hljs-number">44820</span>,
  from: 'lax1uqug0zq7rcxddndleq4ux2ft3tv6dqljphydrl',
  gasUsed: <span class="hljs-number">44820</span>,
  logsBloom:
'0x<span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000000000</span><span class="hljs-number">00000000</span>',
  status: true,
  to: '0x<span class="hljs-number">0680</span>df2d6e38e5a6c89e<span class="hljs-number">385683</span>6e017c<span class="hljs-number">6572</span>dab2',<span class="hljs-comment">//交易调用的合约地址</span>
  transactionHash:
   '0x2b381a8efab<span class="hljs-number">4774</span>ae029fdf2e<span class="hljs-number">2585</span>b48c03c033c64d543c9c606c<span class="hljs-number">925689</span>fca31',<span class="hljs-comment">//交易hash</span>
  transactionIndex: <span class="hljs-number">0</span>,
  events: {} }
</code></pre>
<p><strong>step4.</strong>  合约查询</p>
<pre><code class="hljs css language-javascript">helloWorld.methods.getName().call(<span class="hljs-literal">null</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error,result</span>)</span>{<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"name is:"</span> + result);})  
</code></pre>
<p>查询合约命令说明：</p>
<ul>
<li><code>helloWorld</code> 是之前构建的合约对象</li>
<li><code>methods</code> 指定将获取合约中的方法</li>
<li><code>getName</code> 是我们HelloWorld合约中的一个方法，该方法没有入参，故入参为空</li>
<li><code>call</code> 指明是查询方法</li>
<li><code>function</code> 是一个回调函数，将处理调用后的结果，此处我们通过console.log打印出执行结果</li>
</ul>
<hr>
<h2><a class="anchor" aria-hidden="true" id="众筹合约"></a><a href="#众筹合约" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>众筹合约</h2>
<h3><a class="anchor" aria-hidden="true" id="简介-1"></a><a href="#简介-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简介</h3>
<p>​        在下面的例子中，我们将使用合约进行一次众筹。合约创建者发起众筹，并初始化众筹的代币数量及众筹持续的时间。如果在指定时间内众筹完成则此次众筹成功。并关闭众筹开关，根据一个固定兑换比率得到的一定数量的token会被铸造出来，并且会被计入在买方名下。否则众筹失败，把众筹的金额返还给投资者。</p>
<p>在合约中设置了两个角色</p>
<ul>
<li>众筹者</li>
<li>投资者</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="众筹的流程"></a><a href="#众筹的流程" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>众筹的流程</h3>
<ul>
<li>1.创建众筹合约指受益人</li>
<li>2.部署合约初始化众筹代币数量及持续时间</li>
<li>3.投资者进行投资</li>
<li>4.判断众筹是否结束</li>
<li>如果众筹时间未到，众筹代币数量已完成，关闭众筹开关。给投资者按比例分配token。众筹成功</li>
<li>如果众筹时间已到，众筹代币数量已完成，给投资者按比例分配token。众筹成功</li>
<li>如果众筹时间已到，众筹代币数量未完成，返还投资者代币。众筹失败</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="众筹合约-1"></a><a href="#众筹合约-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>众筹合约</h3>
<pre><code class="hljs">pragma solidity ^<span class="hljs-number">0.5</span><span class="hljs-number">.13</span>;

contract CrowdFunding {
    address payable <span class="hljs-keyword">public</span> beneficiaryAddress = address(<span class="hljs-number">0x0</span>); <span class="hljs-comment">//受益人地址，设置为合约创建者</span>
    uint256 <span class="hljs-keyword">public</span> fundingGoal = <span class="hljs-number">100</span> LAT;  <span class="hljs-comment">//众筹目标，单位是LAT</span>
    uint256 <span class="hljs-keyword">public</span> amountRaised = <span class="hljs-number">0</span>; <span class="hljs-comment">//已筹集金额数量， 单位是VON</span>
    uint256 <span class="hljs-keyword">public</span> deadline; <span class="hljs-comment">//截止时间</span>
    uint256 <span class="hljs-keyword">public</span> price;  <span class="hljs-comment">//代币价格</span>
    <span class="hljs-keyword">bool</span> <span class="hljs-keyword">public</span> fundingGoalReached = <span class="hljs-literal">false</span>;  <span class="hljs-comment">//达成众筹目标</span>
    <span class="hljs-keyword">bool</span> <span class="hljs-keyword">public</span> crowdsaleClosed = <span class="hljs-literal">false</span>; <span class="hljs-comment">//众筹关闭</span>

    mapping(address =&gt; uint256) <span class="hljs-keyword">public</span> balance; <span class="hljs-comment">//保存众筹者对捐赈的金额</span>
    
    mapping(address =&gt; uint256) <span class="hljs-keyword">public</span> tokenMap; <span class="hljs-comment">//保存众筹者所拥有的代币数量</span>

    <span class="hljs-comment">//记录已接收的LAT通知</span>
    <span class="hljs-function"><span class="hljs-keyword">event</span> <span class="hljs-title">GoalReached</span>(<span class="hljs-params">address _beneficiaryAddress, <span class="hljs-keyword">uint</span> _amountRaised</span>)</span>;

    <span class="hljs-comment">//转帐通知</span>
    <span class="hljs-function"><span class="hljs-keyword">event</span> <span class="hljs-title">FundTransfer</span>(<span class="hljs-params">address _backer, <span class="hljs-keyword">uint</span> _amount, <span class="hljs-keyword">bool</span> _isContribution</span>)</span>;
    
    <span class="hljs-comment">//校验地址是否为空</span>
    <span class="hljs-function">modifier <span class="hljs-title">validAddress</span>(<span class="hljs-params">address _address</span>)</span> {
        require(_address != address(<span class="hljs-number">0x0</span>));
        _;
    }

    <span class="hljs-comment">/**
     * 初始化构造函数
     *
     * @param _fundingGoalInlats 众筹LAT币总量
     * @param _durationInMinutes 众筹截止,单位是分钟
     */</span>
    constructor (
        <span class="hljs-keyword">uint</span> _fundingGoalInlats,
        <span class="hljs-keyword">uint</span> _durationInMinutes
    )<span class="hljs-keyword">public</span> {
        beneficiaryAddress = msg.sender;
        fundingGoal = _fundingGoalInlats * <span class="hljs-number">1</span> LAT;
        deadline = now + _durationInMinutes * <span class="hljs-number">1</span> minutes;
        price = <span class="hljs-number">500</span> finney; <span class="hljs-comment">//1个LAT币可以买 2 个代币</span>
    }


    <span class="hljs-comment">/**
     * 默认函数
     *
     * 默认函数，可以向合约直接打款
     */</span>
    function () payable external {

        <span class="hljs-comment">//判断是否关闭众筹</span>
        require(!crowdsaleClosed);
        <span class="hljs-keyword">uint</span> amount = msg.<span class="hljs-keyword">value</span>;

        <span class="hljs-comment">//捐款人的金额累加</span>
        balance[msg.sender] += amount;

        <span class="hljs-comment">//捐款总额累加</span>
        amountRaised += amount;

        <span class="hljs-comment">//转帐操作，转多少代币给捐款人</span>
        tokenMap[msg.sender]  += amount / price;
        
        <span class="hljs-function">emit <span class="hljs-title">FundTransfer</span>(<span class="hljs-params">msg.sender, amount, <span class="hljs-literal">true</span></span>)</span>;
    }

    <span class="hljs-comment">/**
     * 判断是否已经过了众筹截止限期
     */</span>
    <span class="hljs-function">modifier <span class="hljs-title">afterDeadline</span>(<span class="hljs-params"></span>)</span> { <span class="hljs-keyword">if</span> (now &gt;= deadline) _; }

    <span class="hljs-comment">/**
     * 检测众筹目标是否已经达到
     */</span>
    <span class="hljs-function">function <span class="hljs-title">checkGoalReached</span>(<span class="hljs-params"></span>) <span class="hljs-keyword">public</span> afterDeadline payable</span>{
        <span class="hljs-keyword">if</span> (amountRaised &gt;= fundingGoal){
            <span class="hljs-comment">//达成众筹目标</span>
            fundingGoalReached = <span class="hljs-literal">true</span>;
            <span class="hljs-function">emit <span class="hljs-title">GoalReached</span>(<span class="hljs-params">beneficiaryAddress, amountRaised</span>)</span>;
        }

        <span class="hljs-comment">//关闭众筹</span>
        crowdsaleClosed = <span class="hljs-literal">true</span>;
    }


    <span class="hljs-comment">/**
     * 收回资金
     *
     * 检查是否达到了目标或时间限制，如果有，并且达到了资金目标，
     * 将全部金额发送给受益人。如果没有达到目标，每个贡献者都可以退回
     * 他们贡献的金额
     */</span>
    <span class="hljs-function">function <span class="hljs-title">safeWithdrawal</span>(<span class="hljs-params"></span>) <span class="hljs-keyword">public</span> afterDeadline</span> {

        <span class="hljs-comment">//如果没有达成众筹目标</span>
        <span class="hljs-keyword">if</span> (!fundingGoalReached) {
            <span class="hljs-comment">//获取合约调用者已捐款余额</span>
            <span class="hljs-keyword">uint</span> amount = balance[msg.sender];

            <span class="hljs-keyword">if</span> (amount &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-comment">//返回合约发起者所有余额</span>
                msg.sender.transfer(amount);
                <span class="hljs-function">emit <span class="hljs-title">FundTransfer</span>(<span class="hljs-params">msg.sender, amount, <span class="hljs-literal">false</span></span>)</span>;
                balance[msg.sender] = <span class="hljs-number">0</span>;
            }
        }

        <span class="hljs-comment">//如果达成众筹目标，并且合约调用者是受益人</span>
        <span class="hljs-keyword">if</span> (fundingGoalReached &amp;&amp; beneficiaryAddress == msg.sender) {

            <span class="hljs-comment">//将所有捐款从合约中给受益人</span>
            beneficiaryAddress.transfer(amountRaised);
            
            <span class="hljs-function">emit <span class="hljs-title">FundTransfer</span>(<span class="hljs-params">beneficiaryAddress, amountRaised, <span class="hljs-literal">false</span></span>)</span>;
        }
    }
}
</code></pre>
<p><strong>编译众筹合约：</strong></p>
<p><strong>step1.</strong> 为众筹合约创建新目录</p>
<pre><code class="hljs"><span class="hljs-built_in">mkdir</span> myCrowdFunding &amp;&amp; <span class="hljs-built_in">cd</span> myCrowdFunding
</code></pre>
<ul>
<li>以下命令如果没有特殊说明都在myCrowdFunding目录下进行</li>
</ul>
<p><strong>step2.</strong> 使用platon-truffle初始化一个工程</p>
<pre><code class="hljs"><span class="hljs-attribute">platon-truffle init</span>
</code></pre>
<p>在操作完成之后，就有这样的一个项目结构：</p>
<ul>
<li>contracts/: Solidity合约目录</li>
<li>migrations/: 部署脚本文件目录</li>
<li>test/: 测试脚本目录</li>
<li>truffle-config.js: platon-truffle 配置文件</li>
</ul>
<p><strong>step3.</strong> 将编写好的众筹合约放至myCrowdFunding/contracts/目录下</p>
<pre><code class="hljs">ls myCrowdFunding<span class="hljs-regexp">/contracts/</span>
</code></pre>
<ul>
<li>将看到 CrowdFunding.sol</li>
</ul>
<p><strong>step4.</strong> 修改platon-truffle 配置文件truffle-config.js，将编译器版本修改对应的solidity合约中的版本号</p>
<pre><code class="hljs">vim truffle-<span class="hljs-built_in">config</span>.<span class="hljs-keyword">js
</span></code></pre>
<p>truffle-config.js 修改部分内容如下</p>
<pre><code class="hljs"><span class="hljs-selector-tag">compilers</span>: {
     <span class="hljs-attribute">solc</span>: {
        version: <span class="hljs-string">"0.5.13"</span>,    // 此版本号与CrowdFunding.sol中声明的版本号保持一致
    }
}
</code></pre>
<p><strong>step5.</strong> 编译合约</p>
<pre><code class="hljs"><span class="hljs-attribute">platon-truffle compile</span>
</code></pre>
<p>在操作完成之后，就有这样的一个目录结构：</p>
<ul>
<li>build/: Solidity合约编译后的目录</li>
<li>build/contracts/CrowdFunding.json CrowdFunding.sol对应的编译文件</li>
</ul>
<p><strong>部署众筹合约：</strong></p>
<p><strong>step1.</strong> 添加部署脚本文件</p>
<pre><code class="hljs">cd migrations/ &amp;&amp; <span class="hljs-section">touch</span> <span class="hljs-number">2</span>_initial_CrowdFunding.js
</code></pre>
<p>部署脚本文件为:2_initial_crowdFunding.js，内容如下所示：</p>
<pre><code class="hljs"><span class="hljs-keyword">const</span> CrowdFunding = artifacts.require(<span class="hljs-string">"CrowdFunding"</span>); <span class="hljs-comment">//需要部署的合约名称 </span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">deployer</span>) </span>{
      deployer.deploy(CrowdFunding);
};
</code></pre>
<p><strong>step2.</strong> 修改truffle-config.js中链的配置信息</p>
<pre><code class="hljs">vim truffle-<span class="hljs-built_in">config</span>.<span class="hljs-keyword">js
</span></code></pre>
<p>将truffle-config.js中的区块链相关配置修改成您真实连接的链配置</p>
<pre><code class="hljs"><span class="hljs-symbol">networks:</span> {
<span class="hljs-symbol">    development:</span> {
<span class="hljs-symbol">       host:</span> <span class="hljs-string">"10.1.1.6"</span>,     <span class="hljs-comment">// 区块链所在服务器主机</span>
<span class="hljs-symbol">       port:</span> <span class="hljs-number">8806</span>,            <span class="hljs-comment">// 链端口号</span>
<span class="hljs-symbol">       network_id:</span> <span class="hljs-string">"*"</span>,       <span class="hljs-comment">// Any network (default: none)</span>
<span class="hljs-symbol">       from:</span> <span class="hljs-string">"lax1uqug0zq7rcxddndleq4ux2ft3tv6dqljphydrl"</span>, <span class="hljs-comment">//部署合约账号的钱包地址</span>
<span class="hljs-symbol">       gas:</span> <span class="hljs-number">999999</span>,
<span class="hljs-symbol">       gasPrice:</span> <span class="hljs-number">50000000004</span>,
    },
}
</code></pre>
<p><strong>step3.</strong>  部署合约</p>
<pre><code class="hljs"><span class="hljs-attribute">platon-truffle migrate</span>
</code></pre>
<p>部署成功将输出如下信息：</p>
<pre><code class="hljs"><span class="hljs-string">Compiling</span> <span class="hljs-string">your</span> <span class="hljs-string">contracts...</span>
 <span class="hljs-string">Everything</span> <span class="hljs-string">is</span> <span class="hljs-string">up</span> <span class="hljs-string">to</span> <span class="hljs-string">date,</span> <span class="hljs-string">there</span> <span class="hljs-string">is</span> <span class="hljs-string">nothing</span> <span class="hljs-string">to</span> <span class="hljs-string">compile.</span>
 <span class="hljs-string">3_initial_CrowdFunding.js</span>
 
    <span class="hljs-string">Deploying</span> <span class="hljs-string">'CrowdFunding'</span>
     <span class="hljs-attr">transaction hash:</span>    <span class="hljs-number">0x3a6419cd4169d7cfb430a1fc5632239ac4a01845827f20df9b3229a334c5488b</span>
     <span class="hljs-attr">Blocks: 0            Seconds:</span> <span class="hljs-number">0</span>
     <span class="hljs-attr">contract address:</span>    <span class="hljs-string">lax1qtgycm7jkrq8csa2rgef6enlru0u02g8u82kpt</span> <span class="hljs-string">//部署后的合约地址</span>
     <span class="hljs-attr">block number:</span>        <span class="hljs-number">280532</span>
     <span class="hljs-attr">block timestamp:</span>     <span class="hljs-number">1581751224032</span>
     <span class="hljs-attr">account:</span>             <span class="hljs-string">lax1uqug0zq7rcxddndleq4ux2ft3tv6dqljphydrl</span>
     <span class="hljs-attr">balance:</span>             <span class="hljs-number">90000000.806077629992489796</span>
     <span class="hljs-attr">gas used:</span>            <span class="hljs-number">379154</span>
     <span class="hljs-attr">gas price:</span>           <span class="hljs-number">50.000000004</span> <span class="hljs-string">gVON</span>
     <span class="hljs-attr">value sent:</span>          <span class="hljs-number">0</span> <span class="hljs-string">LAT</span>
     <span class="hljs-attr">total cost:</span>          <span class="hljs-number">0.018957700001516616</span> <span class="hljs-string">LAT</span>
 
     <span class="hljs-string">Saving</span> <span class="hljs-string">migration</span> <span class="hljs-string">to</span> <span class="hljs-string">chain.</span>
     <span class="hljs-string">Saving</span> <span class="hljs-string">artifacts</span>
     <span class="hljs-attr">Total cost:</span>     <span class="hljs-number">0.018957700001516616</span> <span class="hljs-string">LAT</span>
</code></pre>
<p><strong>众筹者查询众筹情况：</strong></p>
<p><strong>step1.</strong>  进入platon-truffle控制台</p>
<pre><code class="hljs">platon-truffle<span class="hljs-built_in"> console
</span></code></pre>
<ul>
<li>以下调用查询将在truffle控制台中进行</li>
</ul>
<p><strong>step2.</strong>  构建的众筹合约对象</p>
<pre><code class="hljs"><span class="hljs-keyword">var</span> abi = [...]; <span class="hljs-comment">//众筹合约的ABI，从编译后的文件获取</span>
<span class="hljs-keyword">var</span> contractAddr = <span class="hljs-string">'lax1qtgycm7jkrq8csa2rgef6enlru0u02g8u82kpt'</span>; <span class="hljs-comment">//众筹合约地址</span>
<span class="hljs-keyword">var</span> crowdFunding = <span class="hljs-keyword">new</span> <span class="hljs-type">web3</span>.platon.Contract(abi,contractAddr);  
</code></pre>
<p><strong>step3.</strong>  查询已筹集金额</p>
<pre><code class="hljs">crowdFunding.methods.amountRaised().call(<span class="hljs-literal">null</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error,result</span>)</span>{<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"result:"</span> + result);}); <span class="hljs-comment">//查询已筹集金额</span>
</code></pre>
<p><strong>step4.</strong>  众筹者判断众筹是否成功</p>
<pre><code class="hljs">crowdFunding.methods.safeWithdrawal().send({<span class="hljs-keyword">from</span>:'lax1uqug0zq7rcxddndleq4ux2ft3tv6dqljphydrl'}).<span class="hljs-keyword">on</span><span class="hljs-params">('data', function<span class="hljs-params">(event)</span>{ console.log<span class="hljs-params">(event)</span>;})</span>.<span class="hljs-keyword">on</span><span class="hljs-params">('error', console.error)</span>; 
</code></pre>
<p>调用合约命令说明：</p>
<ul>
<li><code>crowdFunding</code> 是我们之前构建的合约对象</li>
<li><code>methods</code> 固定语法，指定将获取合约中的方法</li>
<li><code>safeWithdrawal</code> 是我们众筹合约中的一个方法，用于收回资金</li>
<li><code>from</code> 调用者的钱包地址</li>
<li><code>on</code> 是监听合约处理结果事件，失败输出错误日志</li>
</ul>
<hr>
<h2><a class="anchor" aria-hidden="true" id="faq"></a><a href="#faq" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FAQ</h2>
<h3><a class="anchor" aria-hidden="true" id="编译相关"></a><a href="#编译相关" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译相关</h3>
<ol>
<li><p>platon-truffle有哪些命令如何使用？</p>
<p>platon-truffle开发使用手册<a href="https://platon-truffle.readthedocs.io/en/v0.11.1/">参考这里</a>。</p></li>
<li><p>合约为什么语法校验通不过？</p>
<p>solidity合约0.4.x版本与0.5.x版本有重大变更，具体语法<a href="https://solidity.readthedocs.io/en/develop/">参考这里</a>。</p></li>
<li><p>platon-truffle执行truffle compile 失败?</p>
<p>1.确认编译的合约文件中的版本号与truffle-config.js中指定的版本号是否一致。
2.可能语法有误，可以根据命令行提示修复后再进行编译。</p></li>
<li><p>platon-truffle执行truffle migrate部署合约失败?</p></li>
</ol>
<p>1.确认truffle-config.js中连接的链的配置信息及用户的钱包地址是否正确。</p>
<ol start="5">
<li>truffle migrate部署带参数的构造函数合约失败?</li>
</ol>
<p>以合约A.sol为例，在migrations/2_initial_A.js文件中，确认是否添加构造参数信息如：
A.sol构造函数格式如下：</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">constructor</span><span class="hljs-params">(uint256 a, <span class="hljs-keyword">string</span> memory b, <span class="hljs-keyword">string</span> memory c)</span> <span class="hljs-title">public</span> <span class="hljs-comment">{}</span>
</span></code></pre>
<p>2_initial_A.js文件配置如下：</p>
<pre><code class="hljs"> <span class="hljs-keyword">const</span> A = artifacts.require(<span class="hljs-string">"A"</span>);  
 <span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">deployer</span>) </span>{
      deployer.deploy(A,<span class="hljs-number">100</span>,<span class="hljs-string">'PLA'</span>,<span class="hljs-string">'PLAT'</span>);<span class="hljs-comment">//需要传入对应构造函数参数</span>
 };   
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/zh-CN/PlatON_system_contract"><span class="arrow-prev">← </span><span>系统合约</span></a><a class="docs-next button" href="/docs/zh-CN/Solidity_Contract_Migrate"><span>合约迁移教程</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#入门手册">入门手册</a><ul class="toc-headings"><li><a href="#简介">简介</a></li><li><a href="#platon-truffle开发工具介绍">platon-truffle开发工具介绍</a></li><li><a href="#创建helloworld合约">创建HelloWorld合约</a></li><li><a href="#编译helloworld合约">编译HelloWorld合约</a></li><li><a href="#部署helloworld合约">部署HelloWorld合约</a></li><li><a href="#调用helloworld合约">调用HelloWorld合约</a></li></ul></li><li><a href="#众筹合约">众筹合约</a><ul class="toc-headings"><li><a href="#简介-1">简介</a></li><li><a href="#众筹的流程">众筹的流程</a></li><li><a href="#众筹合约-1">众筹合约</a></li></ul></li><li><a href="#faq">FAQ</a><ul class="toc-headings"><li><a href="#编译相关">编译相关</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="https://www.platon.network/" class="nav-home"><img src="/docs/img/PlatON-logo2.svg" alt="PlatON" width="66" height="58"/></a><div><a href="https://www.platon.network/">PlatON network</a><a href="https://latticex.foundation/home">Lattice.Foundation</a><a href="https://forum.latticex.foundation/">Forum</a></div><div class="gitstar"><a class="github-button" href="https://github.com/PlatONnetwork/PlatON-Go" data-color-scheme="no-preference: light; light: light; dark: light;" data-icon="octicon-star" data-size="small" data-show-count="true" aria-label="Star PlatONnetwork/PlatON-Go on GitHub">Star</a></div></section><section class="copyright">COPYRIGHT  © 2021 PLATON NETWORK.</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'c2ce4863993980eb049b661be250c773',
                indexName: 'platon',
                inputSelector: '#search_input_react',
                algoliaOptions: {"hitsPerPage":10}
              });
            </script></body></html>